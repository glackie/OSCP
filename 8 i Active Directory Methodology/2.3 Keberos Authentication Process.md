In this section, the sequence of messages to perform authentication will be studied, starting from a user without tickets, up to being authenticated against the desired service.

![](https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-L_2uGJGU7AVNRcqRvEi%2F-M0d9k8nGTCsRCXEJeVB%2F-M0dzvYmaBEj2OnLDaMp%2Fimage.png?alt=media&token=4f7bb9c0-9376-4a24-b42b-8062aa5cdc71)

---

#### **KRB_AS_REQ**

- Firstly, user must get a TGT from KDC. To achieve this, a KRB_AS_REQ must be sent:

![](https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-L_2uGJGU7AVNRcqRvEi%2F-M0d9k8nGTCsRCXEJeVB%2F-M0e-1b8kS6dP9n3rn5O%2Fimage.png?alt=media&token=92108974-1076-4a74-8f11-524436010c54)

- KRB_AS_REQ schema message

- _KRB_AS_REQ_ has, among others, the following fields:

- A encrypted **timestamp** with client key, to authenticate user and prevent replay attacks
    
- **Username** of authenticated user
    
- The service **SPN** asociated with **krbtgt** account
    
- A **Nonce** generated by the user

Note: the encrypted timestamp is only necessary if user requires preauthentication, which is common, except if [_DONT_REQ_PREAUTH_](https://support.microsoft.com/en-us/help/305144/how-to-use-the-useraccountcontrol-flags-to-manipulate-user-account-pro) __ flag is set in user account.

---
#### **KRB_AS_REP**

- After receiving the request, the KDC verifies the user identity by decrypting the timestamp. If the message is correct, then it must respond with a _KRB_AS_REP_:

![](https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-L_2uGJGU7AVNRcqRvEi%2F-M0d9k8nGTCsRCXEJeVB%2F-M0e-5I3O9nITZ1CZAEN%2Fimage.png?alt=media&token=630aab22-ebde-4ef4-9421-c9f73f416c7e)

- KRB_AS_REP schema message

- _KRB_AS_REP_ includes the next information:

- **Username**
    
- **TGT**, which includes:
    
    - **Username**
        
    
    - **Session key**
        
    
    - **Expiration date** of TGT
        
    
    - **PAC** with user privileges, signed by KDC
        
    
- Some **encrypted data** with user key, which includes:
    
    - **Session key**
        
    
    - **Expiration date** of TGT
        
    
    - User **nonce**, to prevent replay attacks

- Once finished, user already has the TGT, which can be used to request TGSs, and afterwards access to the services.

---
#### **KRB_TGS_REQ**

- In order to request a TGS, a _KRB_TGS_REQ_ message must be sent to KDC:

![](https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-L_2uGJGU7AVNRcqRvEi%2F-M0d9k8nGTCsRCXEJeVB%2F-M0e-BZB6eqQ1eLxzRc0%2Fimage.png?alt=media&token=6e22cab6-df52-4aaa-99d4-32c203a4117c)

- KRB_TGS_REQ schema message

- _KRB_TGS_REQ_ includes:

- **Encrypted data** with session key:
    
    - **Username**
        
    
    - **Timestamp**
        
    

- **TGT**
    

- **SPN** of requested service
    

- **Nonce** generated by user
    

---
#### **KRB_TGS_REP**

After receiving the _KRB_TGS_REQ_ message, the KDC returns a TGS inside of _KRB_TGS_REP_:

![](https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-L_2uGJGU7AVNRcqRvEi%2F-M0d9k8nGTCsRCXEJeVB%2F-M0e-EoFuzOOIUHv_lpe%2Fimage.png?alt=media&token=f6c3e3b9-98e7-4a5f-9ddc-14cbbdb4cbcd)

KRB_TGS_REP schema message

_KRB_TGS_REP_ includes:

- **Username**
    

- **TGS**, which contains:
    
    - **Service session key**
        
    
    - **Username**
        
    
    - **Expiration date** of TGS
        
    
    - **PAC** with user privileges, signed by KDC
        
    

- **Encrypted data** with session key:
    
    - **Service session key**
        
    
    - **Expiration date** of TGS
        
    
    - User **nonce**, to prevent replay attacks
        
    

---
**KRB_AP_REQ**

To finish, if everything went well, the user already has a valid TGS to interact with service. 

In order to use it, user must send to the AP a _KRB_AP_REQ_ message:

![](https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-L_2uGJGU7AVNRcqRvEi%2F-M0d9k8nGTCsRCXEJeVB%2F-M0e-HNLgjUjH6ydH_V5%2Fimage.png?alt=media&token=979e0936-3c5a-4210-abc3-9e545b863b76)

KRB_AP_REQ schema message

_KRB_AP_REQ_ includes:

- **TGS**
    

- **Encrypted data** with service session key:
    
    - **Username**
        
    
    - **Timestamp**, to avoid replay attacks
        
    

After that, if user privileges are rigth, this can access to service. 

If is the case, which not usually happens, the AP will verify the PAC against the KDC. 

And also, if mutual authentication is needed it will respond to user with a _KRB_AP_REP_ message.